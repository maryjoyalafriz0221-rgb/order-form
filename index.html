<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Purchase Order Form</title>

<!-- Flatpickr for Date Picker -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<!-- Select2 for Searchable Dropdown -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<style>
    body {font-family: Arial, sans-serif;background-color:#f5f5f5;padding:20px;}
    .container {max-width: 1000px;margin:auto;background:#fff;padding:20px;border-radius:8px;
        box-shadow:0 2px 10px rgba(0,0,0,0.2);}
    h1 {text-align:center;}
    label {font-weight:bold;display:block;margin-top:15px;}
    select, input[type=text], input[type=number] {
        width:100%;padding:8px;margin-top:5px;margin-bottom:15px;border:1px solid #ccc;border-radius:4px;
    }
    table {width:100%;border-collapse:collapse;margin-top:10px;}
    th, td {border:1px solid #ddd;padding:8px;text-align:center;}
    th {background:#f0f0f0;}
    .btn {
        background:#4CAF50;color:white;border:none;padding:10px;margin-top:15px;cursor:pointer;
        border-radius:4px;font-size:16px;
    }
    .btn:hover {background:#45a049;}
</style>
</head>
<body>
<div class="container">
    <h1>Purchase Order Form</h1>

    <form id="poForm">
        <!-- Store Name -->
        <label for="store">Store Name:</label>
        <select name="store" id="store" required>
            <option value="">Select Store</option>
            <option value="FESTIVAL">FESTIVAL</option>
            <option value="SHANG">SHANG</option>
            <option value="POBLA">POBLA</option>
            <option value="EASTWOOD">EASTWOOD</option>
        </select>

        <!-- Delivery Date -->
        <label for="deliveryDate">Date of Delivery:</label>
        <input type="text" id="deliveryDate" name="deliveryDate" required>

        <!-- Item Selection -->
        <label for="itemSelect">Select Item:</label>
        <select id="itemSelect" style="width:100%">
            <option value="" disabled selected>Select an item</option>
        </select>

        <label for="qty">Quantity:</label>
        <input type="number" id="qty" min="1" >

        <button type="button" class="btn" id="addItemBtn">Add to Summary</button>

        <!-- Summary Table -->
        <h3>Summary</h3>
        <table id="summaryTable">
            <thead>
                <tr>
                    <th>Item Description</th>
                    <th>UOM</th>
                    <th>STOCKS</th>
                    <th>Qty</th>
                    <th>Unit Price</th>
                    <th>Amount</th>
                </tr>
            </thead>
            <tbody>
                <tr><td colspan="6">No items selected.</td></tr>
            </tbody>
        </table>

        <button type="submit" class="btn">Submit Order</button>
    </form>
</div>

<script>
let items = [];

// Fetch items from Google Apps Script
fetch("https://script.google.com/macros/s/AKfycbww55n4QWfwtx_NtkrLWopaxHrXC_9J7CWAlE2DvD1N7OGTLo7dkrSXqZ495dlhQnG1/exec") 
  .then(res => res.json())
  .then(data => {
    items = data;

    // Populate Select2 dropdown with item + stock + unit price
    items.forEach(entry => {
      const price = parseFloat(entry.unitPrice) || 0;   // ✅ consistent naming
      const optionText = `${entry.item} (Stock: ${entry.stock}, ₱${price.toFixed(2)})`;
      $("#itemSelect").append(new Option(optionText, entry.item));
    });

    // Initialize Select2
    $("#itemSelect").select2({
      placeholder: "Search for an item",
      allowClear: true
    });
  });

const summaryBody = document.getElementById('summaryTable').querySelector('tbody');

// Add Item to Summary
document.getElementById("addItemBtn").addEventListener("click", () => {
  const itemName = $("#itemSelect").val();
  const qty = parseFloat(document.getElementById("qty").value);
  const item = items.find(i => i.item === itemName);

  if (item && qty > 0) {
    // Remove "No items selected" row
    if (summaryBody.children.length === 1 && summaryBody.children[0].children[0].colSpan === 6) {
      summaryBody.innerHTML = "";
    }

    const unitPrice = parseFloat(item.unitPrice) || 0;   // ✅ consistent naming
    const amount = unitPrice * qty;

    const row = `
      <tr>
        <td>${item.item}</td>
        <td>${item.uom}</td>
        <td>${item.stock}</td>
        <td>${qty}</td>
        <td>₱${unitPrice.toFixed(2)}</td>
        <td>₱${amount.toFixed(2)}</td>
      </tr>`;
    summaryBody.insertAdjacentHTML("beforeend", row);

    // Reset inputs
    $("#itemSelect").val(null).trigger("change");
    document.getElementById("qty").value = "";
  } else {
    alert("Please select a valid item and quantity.");
  }
});

// Submit Order
document.getElementById("poForm").addEventListener("submit", e => {
  e.preventDefault();

  const data = {
    store: document.getElementById('store').value,
    deliveryDate: document.getElementById('deliveryDate').value,
    items: []
  };

  // Collect summary table rows
  summaryBody.querySelectorAll("tr").forEach(row => {
    const cells = row.querySelectorAll("td");
    if (cells.length === 6) {
      data.items.push({
        item: cells[0].textContent,
        uom: cells[1].textContent,
        stock: Number(cells[2].textContent),
        qty: Number(cells[3].textContent),
        unitPrice: Number(cells[4].textContent.replace("₱", "").replace(/,/g, "")),
  	amount: Number(cells[5].textContent.replace("₱", "").replace(/,/g, ""))
      });
    }
  });

  if (data.items.length === 0) {
    alert("Please add at least one item.");
    return;
  }

  fetch("https://script.google.com/macros/s/AKfycbww55n4QWfwtx_NtkrLWopaxHrXC_9J7CWAlE2DvD1N7OGTLo7dkrSXqZ495dlhQnG1/exec", {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  }).then(() => {
    alert("Order submitted successfully!");
    document.getElementById("poForm").reset();
    summaryBody.innerHTML = '<tr><td colspan="6">No items selected.</td></tr>';
    $("#itemSelect").val(null).trigger("change");
  }).catch(err => alert("Error submitting form: " + err));
});



// Flatpickr for date input
flatpickr("#deliveryDate", {
  dateFormat: "Y-m-d",
  minDate: "today",
});

</script>

</body>
</html>
